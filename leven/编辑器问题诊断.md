# 编辑器位置问题诊断和修复

## 📷 从截图观察到的问题

1. **水平位置（X）**：✅ 正确 - 编辑框在Email列
2. **垂直位置（Y）**：❌ 不对 - 有多个编辑框显示在不同行
3. **编辑框数量**：❌ 应该只有1个，但有3个
4. **显示值**：需要确认是否显示了正确的单元格值

## 🔍 问题分析

### 可能的原因

**原因1：垂直位置偏移累加**
- `rect.y` 的计算：`coordInstance.getRowOffset(rowIndex) - scrollTop`
- 如果`rowInitSize`或容器的top偏移没有被正确考虑，可能导致Y坐标偏移

**原因2：padding影响**
- SimpleDemo的容器有 `className="p-4"`（padding: 16px）
- 这个padding可能影响了Grid的实际位置
- EditorContainer定位时没有考虑这个offset

**原因3：多个编辑器实例**
- React严格模式可能导致多次渲染
- 或者EditorContainer在不同的activeCell状态下都在渲染

## ✅ 解决方案

### 方案1：修复容器padding导致的偏移

修改 SimpleDemo.tsx，移除Grid父容器的padding，改用margin：

```tsx
// 当前（有问题）
<div className="p-4 relative" style={{ height: '600px' }}>
  <Grid ... />
</div>

// 修改为
<div className="m-4 relative" style={{ height: '600px' }}>
  <Grid ... />
</div>
```

或者完全使用绝对定位：

```tsx
<div className="relative" style={{ height: '600px', padding: '16px' }}>
  <div className="absolute inset-4">
    <Grid ... />
  </div>
</div>
```

### 方案2：调整EditorContainer的定位基准

如果方案1不行，说明EditorContainer的定位需要考虑Grid父容器的offset。

修改 EditorContainer.tsx 中的位置计算，添加容器offset：

```tsx
const rect = useMemo(() => {
  const { rowInitSize, columnInitSize, containerWidth, containerHeight } = coordInstance;
  
  // 获取Grid容器相对于其父容器的偏移
  const gridContainer = document.querySelector('[data-t-grid-container]');
  const gridParent = gridContainer?.parentElement;
  const offsetY = gridParent && gridContainer 
    ? gridContainer.getBoundingClientRect().y - gridParent.getBoundingClientRect().y
    : 0;
  
  const x = clamp(
    coordInstance.getColumnRelativeOffset(columnIndex, scrollLeft),
    columnInitSize,
    containerWidth - width
  );
  const y = clamp(
    coordInstance.getRowOffset(rowIndex) - scrollTop,
    rowInitSize,
    containerHeight - height
  );

  return {
    x,
    y, // 或者 y + offsetY 如果需要补偿offset
    width,
    height,
    editorId,
  };
}, [coordInstance, rowIndex, columnIndex, width, height, scrollLeft, scrollTop, editorId]);
```

### 方案3：移除StrictMode（临时测试）

在 main.tsx 中临时移除StrictMode来测试是否是双重渲染导致的：

```tsx
// 临时测试
root.render(<SimpleDemo />)

// 而不是
root.render(
  <StrictMode>
    <SimpleDemo />
  </StrictMode>
)
```

---

## 🎯 推荐的修复顺序

1. **先试方案1**：移除padding，改用margin或绝对定位
2. **如果不行再试方案2**：调整位置计算考虑容器offset
3. **最后试方案3**：临时移除StrictMode测试

---

**下一步**：请告诉我想先尝试哪个方案，或者提供更多截图/信息


